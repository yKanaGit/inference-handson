---
apiVersion: batch/v1
kind: Job
metadata:
  name: job-download-model-yolo
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  backoffLimit: 4
  template:
    spec:
      containers:
        - name: job-download-model-yolo
          image: registry.access.redhat.com/ubi9/python-312:latest
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash"]
          args:
            - -c
            - |
                set -euo pipefail
                pip install huggingface_hub
                python - <<'PYCODE'
                import pathlib
                import shutil
                from huggingface_hub import hf_hub_download

                repo_id = "keremberke/yolov8n-onnx"
                filename = "model.onnx"

                target = pathlib.Path("/mnt/model/yolov8n/1/model.onnx")
                target.parent.mkdir(parents=True, exist_ok=True)

                downloaded = hf_hub_download(
                    repo_id=repo_id,
                    filename=filename,
                    local_dir=target.parent,
                    local_dir_use_symlinks=False,
                )
                print(f"Downloaded: {downloaded}")
                shutil.copy2(downloaded, target)
                print(f"Copied to: {target}")
                PYCODE
                cat <<'EOCONFIG' > /mnt/model/yolov8n/config.pbtxt
                name: "yolov8n"
                platform: "onnxruntime_onnx"
                max_batch_size: 1
                input [
                  {
                    name: "images"
                    data_type: TYPE_FP32
                    format: FORMAT_NCHW
                    dims: [3, 640, 640]
                  }
                ]
                output [
                  {
                    name: "output0"
                    data_type: TYPE_FP32
                    dims: [84, 8400]
                  }
                ]
                instance_group [
                  { kind: KIND_GPU }
                ]
                EOCONFIG
                sync
          volumeMounts:
            - name: model-storage-yolo
              mountPath: /mnt
      volumes:
        - name: model-storage-yolo
          persistentVolumeClaim:
            claimName: model-storage-yolo
      restartPolicy: Never
